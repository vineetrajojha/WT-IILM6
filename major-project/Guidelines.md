# StudymateAI — AI IDE Generation Guidelines

> These guidelines are intended for use as a system prompt or context file in AI-powered IDEs (Cursor, Windsurf, GitHub Copilot Workspace, etc.). Paste or reference this file so the AI understands the full project architecture, conventions, and constraints before generating any code.

---

## 1. Project Identity

| Field        | Value                                      |
|--------------|--------------------------------------------|
| Project Name | StudymateAI                                |
| Type         | Full-stack web application                 |
| Purpose      | AI-powered exam study planner for students |
| Version      | 1.0.0 (MVP)                                |

---

## 2. Tech Stack

Always use **only** the following technologies. Do not introduce libraries outside this list without explicit instruction.

### Core
- **Framework:** Next.js 14+ with App Router (no Pages Router)
- **Language:** TypeScript (strict mode — `"strict": true` in tsconfig)
- **Styling:** Tailwind CSS v3
- **UI Components:** shadcn/ui (Radix primitives under the hood)
- **Icons:** Lucide React

### Backend / Data
- **Database:** PostgreSQL (via Supabase or Railway)
- **ORM:** Drizzle ORM (never Prisma)
- **Schema location:** `src/db/schema.ts`
- **Auth:** NextAuth.js v5 (Auth.js) with Google + Email providers

### AI
- **Primary AI SDK:** Vercel AI SDK (`ai` package)
- **AI Provider:** Anthropic Claude (`@ai-sdk/anthropic`) — model: `claude-sonnet-4-20250514`
- **Streaming:** Always stream AI responses using `streamText` or `streamObject`
- **Structured output:** Use `generateObject` with Zod schemas for parsing tasks

### Scheduling & Jobs
- **Cron:** Vercel Cron Jobs (defined in `vercel.json`)
- **Background jobs (optional):** Inngest for complex workflows
- **Email:** Resend + React Email

### Dev & Infra
- **Package manager:** pnpm
- **Linting:** ESLint with `eslint-config-next`
- **Formatting:** Prettier (`.prettierrc` at root)
- **Deployment:** Vercel

---

## 3. Project Structure

Strictly follow this folder structure. Never deviate unless asked.

```
studymateai/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── (auth)/                   # Auth route group
│   │   │   ├── login/page.tsx
│   │   │   └── register/page.tsx
│   │   ├── (dashboard)/              # Protected route group
│   │   │   ├── layout.tsx
│   │   │   ├── dashboard/page.tsx
│   │   │   ├── exams/
│   │   │   │   ├── page.tsx          # All exams list
│   │   │   │   ├── new/page.tsx      # Create exam
│   │   │   │   └── [examId]/
│   │   │   │       ├── page.tsx      # Exam overview
│   │   │   │       ├── timetable/page.tsx
│   │   │   │       ├── topics/page.tsx
│   │   │   │       ├── flashcards/page.tsx
│   │   │   │       └── analytics/page.tsx
│   │   │   └── settings/page.tsx
│   │   ├── api/
│   │   │   ├── auth/[...nextauth]/route.ts
│   │   │   ├── ai/
│   │   │   │   ├── parse-syllabus/route.ts
│   │   │   │   ├── generate-timetable/route.ts
│   │   │   │   ├── replan/route.ts
│   │   │   │   └── flashcards/route.ts
│   │   │   └── cron/
│   │   │       ├── daily-reminder/route.ts
│   │   │       ├── weekly-digest/route.ts
│   │   │       ├── streak-reset/route.ts
│   │   │       └── replan/route.ts
│   │   ├── layout.tsx                # Root layout
│   │   └── page.tsx                  # Landing page
│   ├── components/
│   │   ├── ui/                       # shadcn/ui primitives (auto-generated)
│   │   ├── layout/                   # Sidebar, Header, Nav
│   │   ├── exams/                    # Exam-specific components
│   │   ├── timetable/                # Calendar, session cards
│   │   ├── topics/                   # Topic tree, editor
│   │   ├── flashcards/               # Card flip UI
│   │   ├── analytics/                # Charts, heatmaps
│   │   └── shared/                   # Reusable: Loader, Empty, Badge, etc.
│   ├── db/
│   │   ├── schema.ts                 # All Drizzle table definitions
│   │   ├── index.ts                  # DB client export
│   │   └── migrations/               # Auto-generated by drizzle-kit
│   ├── lib/
│   │   ├── ai/
│   │   │   ├── prompts.ts            # All AI prompt templates
│   │   │   ├── parse-syllabus.ts
│   │   │   ├── generate-timetable.ts
│   │   │   └── replan.ts
│   │   ├── auth.ts                   # NextAuth config
│   │   ├── db.ts                     # Drizzle client singleton
│   │   ├── email/
│   │   │   ├── send.ts
│   │   │   └── templates/            # React Email templates
│   │   └── utils.ts                  # General helpers (cn, formatDate, etc.)
│   ├── actions/                      # Next.js Server Actions
│   │   ├── exam.actions.ts
│   │   ├── session.actions.ts
│   │   ├── topic.actions.ts
│   │   └── user.actions.ts
│   ├── hooks/                        # Custom React hooks
│   │   ├── use-exam.ts
│   │   ├── use-progress.ts
│   │   └── use-timer.ts
│   └── types/
│       ├── db.ts                     # Drizzle inferred types
│       └── api.ts                    # API request/response types
├── public/
├── emails/                           # React Email preview dev server
├── drizzle.config.ts
├── vercel.json                       # Cron job definitions
├── tailwind.config.ts
├── tsconfig.json
└── .env.local                        # Never commit this
```

---

## 4. Database Schema Rules

All tables are defined in `src/db/schema.ts` using **Drizzle ORM with the PostgreSQL dialect**.

### Conventions
- All primary keys use `cuid2` (never auto-increment integers)
- All tables include `createdAt` and `updatedAt` timestamps
- Foreign keys must reference their parent table explicitly
- Column names use `camelCase` in schema, Drizzle maps to `snake_case` in SQL
- Use `pgEnum` for any column with a fixed set of values

### Core Tables Reference

```ts
// Reference — do not regenerate unless schema changes are requested

users          // id, name, email, image, plan (free|pro), timezone, notifPrefs
exams          // id, userId, subject, examDate, status (active|completed|archived)
topics         // id, examId, title, parentId, weight, difficulty, orderIndex
sessions       // id, examId, topicId, scheduledDate, durationMins, status (pending|done|partial|skipped)
progressLogs   // id, userId, sessionId, action, notes, loggedAt
flashcards     // id, topicId, front, back, easeFactor, nextReviewAt
reminders      // id, userId, examId, type, sendAt, channel (email|push), status, payload
streaks        // id, userId, currentStreak, longestStreak, lastStudiedAt
```

### Rules
- Never use `any` type on database query results — always use Drizzle's inferred types via `typeof schema.tableName.$inferSelect`
- Always wrap multi-step DB operations in a Drizzle transaction
- Never write raw SQL unless Drizzle cannot express the query

---

## 5. API Route Conventions

### Route Handler Template

```ts
// src/app/api/[route]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { z } from 'zod'

const RequestSchema = z.object({ /* ... */ })

export async function POST(req: NextRequest) {
  const session = await auth()
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const body = await req.json()
  const parsed = RequestSchema.safeParse(body)
  if (!parsed.success) {
    return NextResponse.json({ error: parsed.error.flatten() }, { status: 400 })
  }

  // ... handler logic

  return NextResponse.json({ data: result })
}
```

### Rules
- Every route must authenticate the user first — no exceptions
- Validate all request bodies with Zod before processing
- Return consistent error shapes: `{ error: string | object }`
- Return consistent success shapes: `{ data: T }`
- AI streaming routes use `return result.toDataStreamResponse()` — never `NextResponse.json()`
- Cron routes must verify the `Authorization: Bearer ${CRON_SECRET}` header

---

## 6. Server Actions Conventions

Prefer **Server Actions** over API routes for form submissions and data mutations triggered by UI events.

```ts
// src/actions/exam.actions.ts
'use server'

import { auth } from '@/lib/auth'
import { db } from '@/lib/db'
import { exams } from '@/db/schema'
import { revalidatePath } from 'next/cache'
import { z } from 'zod'

const CreateExamSchema = z.object({
  subject: z.string().min(1).max(100),
  examDate: z.coerce.date(),
})

export async function createExam(formData: FormData) {
  const session = await auth()
  if (!session?.user?.id) throw new Error('Unauthorized')

  const parsed = CreateExamSchema.parse({
    subject: formData.get('subject'),
    examDate: formData.get('examDate'),
  })

  const [exam] = await db.insert(exams).values({
    id: createId(),
    userId: session.user.id,
    ...parsed,
  }).returning()

  revalidatePath('/dashboard')
  return exam
}
```

### Rules
- Always start with `'use server'` directive
- Always authenticate at the top of every action
- Always validate input with Zod
- Always call `revalidatePath` or `revalidateTag` after mutations
- Never expose raw database errors to the client — catch and rethrow safe messages

---

## 7. AI Integration Rules

All AI calls live in `src/lib/ai/`. Route handlers call these functions — never write AI logic directly in route files.

### Syllabus Parsing

```ts
// src/lib/ai/parse-syllabus.ts
import { generateObject } from 'ai'
import { anthropic } from '@ai-sdk/anthropic'
import { z } from 'zod'

const TopicSchema = z.object({
  title: z.string(),
  weight: z.number().min(1).max(10),
  difficulty: z.enum(['easy', 'medium', 'hard']),
  subtopics: z.array(z.string()),
})

const SyllabusSchema = z.object({
  subject: z.string(),
  units: z.array(z.object({
    title: z.string(),
    topics: z.array(TopicSchema),
  }))
})

export async function parseSyllabus(raw: string) {
  const { object } = await generateObject({
    model: anthropic('claude-sonnet-4-20250514'),
    schema: SyllabusSchema,
    prompt: PROMPTS.parseSyllabus(raw),
  })
  return object
}
```

### Rules
- Always use `claude-sonnet-4-20250514` as the model — never hardcode a different model
- Use `generateObject` + Zod schema for structured parsing tasks (syllabus, timetable)
- Use `streamText` for conversational or long-form outputs shown to users
- All prompts live in `src/lib/ai/prompts.ts` as named exports — never inline prompt strings in logic files
- Always handle AI errors with try/catch and return a typed error to the caller
- Never expose the raw AI error object to the client

---

## 8. Prompt Engineering Rules (`src/lib/ai/prompts.ts`)

```ts
export const PROMPTS = {
  parseSyllabus: (raw: string) => `
You are an expert academic curriculum analyst.
Parse the following syllabus text into a structured JSON output.

Rules:
- Extract every unique topic and subtopic
- Assign a difficulty score (easy | medium | hard) based on topic complexity keywords
- Assign a weight (1–10) based on how much space the topic takes relative to the full syllabus
- Group topics under their parent unit/chapter

Syllabus:
"""
${raw}
"""
`,

  generateTimetable: (params: TimetableParams) => `...`,
  replan: (params: ReplanParams) => `...`,
  generateFlashcards: (topic: string, context: string) => `...`,
}
```

### Rules
- All prompts are pure functions that take typed parameters and return a string
- Include explicit output format instructions in every prompt
- Never ask the AI to "do its best" — be specific and directive
- For timetable and replan prompts, always pass the exam date, today's date, and days remaining explicitly

---

## 9. Component Conventions

### File Naming
- Page components: `page.tsx` (Next.js convention)
- Layouts: `layout.tsx`
- Feature components: `PascalCase.tsx` (e.g., `TopicCard.tsx`, `TimetableCalendar.tsx`)
- Hooks: `camelCase.ts` prefixed with `use-` (e.g., `use-exam.ts`)

### Component Template

```tsx
// Always define prop types inline above the component
interface TopicCardProps {
  topic: TopicSelect
  onMarkDone: (id: string) => void
}

export function TopicCard({ topic, onMarkDone }: TopicCardProps) {
  return (
    <div className="...">
      {/* ... */}
    </div>
  )
}
```

### Rules
- Never use `default export` for components — always use named exports
- Never use `React.FC` — use plain function declarations with typed props
- Client components (`'use client'`) only when required (event handlers, hooks, browser APIs)
- Keep server components as the default — fetch data directly in them using `async/await`
- Never fetch data inside a `useEffect` when a server component or server action can do it
- Compose from `shadcn/ui` primitives first before writing custom UI

---

## 10. Styling Rules

- Use **Tailwind CSS utility classes only** — no inline styles, no CSS modules
- Use the `cn()` helper from `src/lib/utils.ts` for conditional class merging (clsx + tailwind-merge)
- Colour tokens must reference the Tailwind config, not hardcoded hex values
- Keep class lists readable — split onto multiple lines for components with more than 5 classes
- Dark mode is supported via `class` strategy — use `dark:` variants

### Tailwind Config Theme Additions

```ts
// tailwind.config.ts — extend with brand colours
extend: {
  colors: {
    brand: {
      50:  '#f0fdf4',
      500: '#0d9488',  // primary teal
      900: '#0f172a',  // dark
    }
  }
}
```

---

## 11. Cron Job Conventions

Cron schedules are defined in `vercel.json`:

```json
{
  "crons": [
    { "path": "/api/cron/daily-reminder",  "schedule": "0 7 * * *"  },
    { "path": "/api/cron/weekly-digest",   "schedule": "0 8 * * 0"  },
    { "path": "/api/cron/streak-reset",    "schedule": "59 23 * * *" },
    { "path": "/api/cron/replan",          "schedule": "0 0 * * *"  }
  ]
}
```

### Cron Route Template

```ts
// src/app/api/cron/daily-reminder/route.ts
import { NextRequest, NextResponse } from 'next/server'

export async function GET(req: NextRequest) {
  const authHeader = req.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // ... batch processing logic

  return NextResponse.json({ ok: true, processed: count })
}
```

### Rules
- All cron routes use `GET` — never `POST`
- Always validate `CRON_SECRET` before executing any logic
- Process users in batches of 50 — never query all users at once
- Log the number of records processed in the response for observability
- Never trigger AI calls directly in cron routes — queue them or call the AI lib functions with timeouts

---

## 12. Environment Variables

All environment variables must be declared in `.env.local` (never committed) and referenced via `process.env`.

```bash
# Database
DATABASE_URL=

# Auth
AUTH_SECRET=
AUTH_GOOGLE_ID=
AUTH_GOOGLE_SECRET=

# AI
ANTHROPIC_API_KEY=

# Email
RESEND_API_KEY=

# Cron
CRON_SECRET=

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### Rules
- Variables prefixed with `NEXT_PUBLIC_` are exposed to the client — never put secrets there
- Access env vars via `process.env.VAR_NAME` — never destructure at module level
- If an env var is missing at runtime, throw a clear error: `if (!process.env.X) throw new Error('Missing env: X')`

---

## 13. Error Handling

### Server Side
- Wrap all async logic in `try/catch`
- Log errors with context: `console.error('[parse-syllabus]', error)`
- Return typed errors, not raw exceptions

### Client Side
- Use React Error Boundaries for page-level failures
- Use `toast` (shadcn Sonner) for action feedback — success and error states
- Never show raw error messages to users — map to human-readable strings

---

## 14. TypeScript Rules

- `strict: true` is non-negotiable — fix all type errors, never use `@ts-ignore`
- No `any` — use `unknown` and narrow with type guards when type is truly unknown
- Prefer `type` over `interface` for object shapes (unless extending)
- Export all shared types from `src/types/`
- Infer database types from Drizzle: `type ExamSelect = typeof exams.$inferSelect`

---

## 15. Code Generation Dos & Don'ts

### ✅ DO
- Generate complete, working files — not partial snippets unless asked
- Follow the exact folder structure from Section 3
- Add JSDoc comments to all exported functions
- Use early returns to reduce nesting
- Name variables and functions descriptively — no `data`, `res`, `obj`
- Keep components under 200 lines — extract sub-components when needed
- Write accessible markup — use semantic HTML and ARIA attributes on interactive elements

### ❌ DON'T
- Don't generate placeholder `// TODO` comments — write the actual logic
- Don't use `any` type
- Don't use `default export` for components
- Don't put business logic inside components — extract to hooks or actions
- Don't install unlisted packages without flagging it first
- Don't use `useEffect` for data fetching — use server components or server actions
- Don't write raw SQL — use Drizzle query builders
- Don't inline AI prompts — always use `PROMPTS.*` from `src/lib/ai/prompts.ts`
- Don't generate migration files manually — always use `drizzle-kit generate`

---

## 16. Feature Flags

Upcoming features that are NOT yet in scope for the current sprint. Do not generate code for these unless explicitly requested:

- `FEAT_STUDY_GROUPS` — collaborative group rooms
- `FEAT_PAST_PAPERS` — past paper upload and analysis
- `FEAT_CALENDAR_SYNC` — Google / Apple Calendar OAuth
- `FEAT_STRIPE` — subscription billing
- `FEAT_OFFLINE_PWA` — service worker and offline mode

---

## 17. Testing Guidelines

- Unit tests: Vitest for utility functions and AI prompt helpers
- Integration tests: Vitest + msw for API route handlers
- E2E tests: Playwright for critical user flows (signup → create exam → view timetable)
- Test files colocated: `*.test.ts` next to the file being tested
- Never mock the database in unit tests — use a test PostgreSQL database with migrations applied

---

*End of guidelines. When generating code, always check this file first to ensure the output conforms to the conventions above.*
